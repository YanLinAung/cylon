#!/usr/bin/env node

var program = require('commander'),
    sys = require('sys'),
    exec = require('child_process').exec,
    os = require('os'),
    pkg = require('../package.json'),
    fs = require('fs');

var stdExec = function(command){
  exec(command, function(error, stdout, stderr){
    sys.print(stdout);
    if (stderr != '' && stderr != null){
      sys.print('Some errors were found: \n' + stderr);
    }
  });
}

program
  .version(pkg.version)
  .usage('[command] [options]');

program
  .command("generate <name>")
  .description("Generates a new adaptor")
  .action(function(name) { require('../src/generators/adaptor')(name) });

program
  .command("scan <type>")
  .description("Scans usb port for connected devices")
  .action(function(type) {
    switch(os.platform()){
    case 'linux':
      switch(type){
      case 'serial':
        stdExec('ls /dev/tty*');
        break;
      case 'bluetooth':
        stdExec('hcitool scan');
        break;
      case 'usb':
        stdExec('lsusb');
        break;
      default:
        sys.print('Device type not yet supported...\n')
      }
      break;
    case 'darwin':
      stdExec('ls /dev/tty*');
      break;
    default:
      sys.print('OS not yet supported...\n')
      break;
    }
  });

argv = program.parse(process.argv);

var modules_path = process.cwd() + '/node_modules/';

if (fs.existsSync(modules_path)) {
  // require all cylon-* modules
  fs.readdirSync(modules_path).forEach(function(dir) {
    if (dir.match(/^cylon-.*/) !== null) {
      if (typeof require(dir).registerCommands === 'function') {
        var commands = require(dir).registerCommands();
        for (name in commands) {
          var command = commands[name];

          // get subcommand arguments
          args = argv.args.slice(1)

          program
            .command(name)
            .description(command.description)
            .action(command.command(args));
        }
      }
    }
  });
}

// print help if no arguments were provided
if(!program.args.length) { program.help(); }
